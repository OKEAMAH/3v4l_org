<script src="http://ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js"></script>
<script src="ext/shjs/sh_php.min.js"></script>
<script src="ext/shjs/sh_main.min.js"></script>
<link rel="stylesheet" type="text/css" href="ext/shjs/sh_style.css"/>
<style type="text/css">
.editable {
	border: 1px solid #ddd;
	padding: 10px;
	margin: 10px;
	min-height: 100px;
	color: #333;
}
.editable .comment { color: gray; }
.editable > .keyword { color: blue; }
.editable > .variable { color: green; }
.editable > .string { color: red; }

</style>
<script type="text/javascript">

var phpEditor = new Class({
	element: null,
	keywords: ['abstract', 'and', 'array', 'as', 'break', 'callable', 'case', 'catch', 'class', 'clone', 'const', 'continue', 'declare', 'default',
		'die', 'do', 'echo', 'else', 'elseif', 'empty', 'enddeclare', 'endfor', 'endforeach', 'endif', 'endswitch', 'endwhile', 'eval', 'exit', 'extends',
		'final', 'finally', 'for', 'foreach', 'function', 'global', 'goto', 'if', 'implements', 'include', 'include_once', 'instanceof', 'interface',
		'isset', 'list', 'namespace', 'new', 'or', 'print', 'private', 'protected', 'public', 'require', 'require_once', 'return', 'static', 'switch',
		'throw', 'trait', 'try', 'unset', 'use', 'var', 'while', 'true', 'false', 'null'],

	initialize: function(el)
	{
		this.element = el;

		el.addEvent('keyup', this.onChange);

		this.onChange();
	},

	onChange: function (e)
	{
		try
		{
			var sel = this.saveSelection();
		}
		catch (ex)
		{
			var sel = false;
		}

//		if ('enter' == e.key)
//			return false;
		
//		this.element.innerHTML= this.element.innerHTML.replace(/<\/?div>/g, "\n");

		while (this.element.innerHTML != (stripped = this.element.innerHTML.replace(/<span class=".*?">([\s\S]*?)<\/span>/g, "$1")))
			this.element.innerHTML = stripped;


		sh_highlightDocument()

		if (sel)
			this.restoreSelection(sel);
	},

	traverseText: function(n, c)
	{
		if (n.nodeType == 3)
			c(n);
		else
			for (var i = 0, len = n.childNodes.length; i<len; ++i)
				this.traverseText(n.childNodes[i], c);
	},

	saveSelection: function()
	{
		var offset = 0, start = 0, end = 0, found = false, stop = {};
		var processText = function(n)
		{
			if (!found && n == range.startContainer)
			{
				start = offset + range.startOffset;
				found = true;
			}

			if (found && n == range.endContainer)
			{
				end = offset + range.endOffset;
				throw stop;
			}

			offset += n.length;
		}

		var sel = window.getSelection(), range = sel.getRangeAt(0);
		if (sel.rangeCount)
		{
			try
			{
				this.traverseText(this.element, processText);
			}
			catch (ex)
			{
				if (ex != stop)
					throw ex;
			}
		}

		return {
			start: start,
			end: end
		};
	},

	restoreSelection: function(sel)
	{
		var offset = 0, range = document.createRange(), found = false, stop = {};
		range.collapse(this.element, 0);

		var processText = function(n)
		{
			var nextOffset = offset + n.length;

			if (!found && sel.start >= offset && sel.start <= nextOffset)
			{
				range.setStart(n, sel.start - offset);
				found = true;
			}

			if (found && sel.end >= offset && sel.end <= nextOffset)
			{
				range.setEnd(n, sel.end - offset);
				throw stop;
			}

			offset = nextOffset;
		}

		try
		{
			this.traverseText(this.element, processText);
		}
		catch (ex)
		{
			if (ex != stop)
				throw ex;

			window.getSelection().removeAllRanges();
			window.getSelection().addRange(range);
		}
	},
});

window.addEvent('domready', function(){ new phpEditor($('c')); });
</script>
<pre class="sh_php" contentEditable="true" id="c">
&lt;?php

class Stuff
{
	/*
		Important comment
	*/
	public static function countObjTypes( array $data, array $types )
	{
#		$return['Other'] = 0;

		foreach ( $types as $type )
			$return[$type] = 0;

		foreach ( ( array ) $data as $obj ) {
			$set = false;
			array_walk( $types, function( $type ) use ( $obj, &amp;$return, &amp;$set )
			{
				if ( is_a( $obj, $type ) ) {
					$return[$type]++;
					$set = true;
				}
			} );

			if ( !$set )
				$return['Other']++;
		}

		return $return;
	}
}

// An example of how to use it
$form  = new Form( 'Form', 'post' );

$honeyPot1 = new HoneyPotField( time() );
$honeyPot1-&gt;validator( new Validator( new HoneyPotTimeRule( 'This form was filled in too quickly, assumed bot, please allow 2 seconds to fill in the form' ) ) );
$honeyPot2 = new HoneyPotField();
$honeyPot2-&gt;validator( new Validator( new EqualRule( 'This field was unexpectedly filled in, assumed bot', '' ) ) );

if( $form-&gt;isSubmitted() )
	$form-&gt;validate(  );
echo $form-&gt;render(  ); // outputs the form + elements
</pre>
