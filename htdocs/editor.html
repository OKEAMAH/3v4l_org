<html><head>
<script src="http://ajax.googleapis.com/ajax/libs/mootools/1.4.5/mootools-yui-compressed.js"></script>
<script src="ext/shjs/sh_php.min.js"></script>
<script src="ext/shjs/sh_main.min.js"></script>
<style type="text/css">
		.sh_php
		{
			border: 1px solid #ddd;
			margin: 10px;
			min-height: 100px;
			color: #333;
			counter-reset: lineno;
		}
		.sh_php .sh_comment { color: #a50; }
		.sh_php .sh_keyword { color: #708; }
		.sh_php .sh_variable { color: #05a; }
		.sh_php .sh_string { color: #a11; }

		code
		{
			background: #f7f7f7;
			white-space: pre;
			display: block;
		}

		.line
		{
			counter-increment: lineno;
			display: block;
			margin-left: 2.5em;
			clear: both;
			border-left: 1px solid gray;
			padding-left: 0.5em;
			background: white;
		}

		.line::before
		{
			color: #aaa;
			content: counter(lineno);
			padding-right: 10px;
			-webkit-user-select: none;
			-moz-user-select: none;
			display: block;
			float: left;
			margin-left: -3em;
			text-align: right;
			width: 2em;
		}
</style>
<script type="text/javascript">

var phpEditor = new Class({
	element: null,
	keywords: ['abstract', 'and', 'array', 'as', 'break', 'callable', 'case', 'catch', 'class', 'clone', 'const', 'continue', 'declare', 'default',
		'die', 'do', 'echo', 'else', 'elseif', 'empty', 'enddeclare', 'endfor', 'endforeach', 'endif', 'endswitch', 'endwhile', 'eval', 'exit', 'extends',
		'final', 'finally', 'for', 'foreach', 'function', 'global', 'goto', 'if', 'implements', 'include', 'include_once', 'instanceof', 'interface',
		'isset', 'list', 'namespace', 'new', 'or', 'print', 'private', 'protected', 'public', 'require', 'require_once', 'return', 'static', 'switch',
		'throw', 'trait', 'try', 'unset', 'use', 'var', 'while', 'true', 'false', 'null'],
	revisions: [],
	undoIndex: null,

	initialize: function(el)
	{
		this.element = el;

		el.addEvent('keydown', this.onKeydown.bind(this));
		el.addEvent('keyup', this.onKeyup.bind(this));

		this.highlight();
	},

	stripHtml: function()
	{
		while (this.element.innerHTML != (stripped = this.element.innerHTML.replace(/<span class=".*?">([\s\S]*?)<\/span>/g, "$1")))
			this.element.innerHTML = stripped;
	},

	highlight: function()
	{
		this.element.innerHTML = '<span class="line">'+ this.element.innerHTML.replace(/\n/g, '\n</span><span class="line">') +'</span>';
		sh_highlightElement(this.element, sh_languages['php']);
	},

	onKeyup: function (e)
	{
		this.onChange(e);
	},

	onKeydown: function (e)
	{
		if ('tab' == e.key && !e.shift && !e.alt)
		{
//FIXME: handle shift+tab
			this.insertText(document.createTextNode("\t"));
			e.preventDefault();
			this.onChange(e, 1);
		}
		else if ('enter' == e.key)
		{
			this.insertText(document.createTextNode("\n"));
			e.preventDefault();
			this.onChange(e, 2);
		}
	},

	onChange: function (e, incrPos)
	{
		var sel = this.saveSelection();

		if (['up', 'down', 'left', 'right'].contains(e.key) || '%11' == escape(e.key))
			return;
		else if ('z' == e.key && e.control)
		{
			if (!this.undoIndex)
				this.undoIndex = this.revisions.length-1;

			this.undoIndex = Math.max(this.undoIndex-1, 0);
		}
		else if ('y' == e.key && e.control && this.undoIndex)
		{
			this.undoIndex = Math.min(this.undoIndex+1, this.revisions.length);
		}
		else if (this.undoIndex)
		{
			while (this.undoIndex < this.revisions.length)
				this.revisions.pop()

			this.undoIndex = null;
		}

		if (incrPos)
		{
			sel.start += incrPos;
			sel.end += incrPos;
		}

		if (this.undoIndex)
			this.element.innerHTML = this.revisions[ this.undoIndex ];
		else
		{
			this.stripHtml();

			this.revisions.push(this.element.innerHTML);
			if (this.revisions.length > 30)
				this.revisions.shift();
		}

		console.log("index: "+this.undoIndex, "undoLength: "+this.revisions.length, sel);

		this.highlight();

		this.restoreSelection(sel);
	},

	insertText: function(el)
	{
		window.getSelection().getRangeAt(0).insertNode(el);
	},

	traverseText: function(n, c)
	{
		if (n.nodeType == 3)
			c(n);
		else
			for (var i = 0, len = n.childNodes.length; i<len; ++i)
				this.traverseText(n.childNodes[i], c);
	},

	saveSelection: function()
	{
		var offset = 0, start = 0, end = 0, found = false, stop = {};
		var processText = function(n)
		{
			if (!found && n == range.startContainer)
			{
				start = offset + range.startOffset;
				found = true;
			}

			if (found && n == range.endContainer)
			{
				end = offset + range.endOffset;
				throw stop;
			}

			offset += n.length;
		}

		var sel = window.getSelection(), range = sel.getRangeAt(0);

		if (sel.rangeCount)
		{
			try
			{
				this.traverseText(this.element, processText);
			}
			catch (ex)
			{
				if (ex != stop)
					throw ex;
			}
		}

		return {
			start: start,
			end: end
		};
	},

	restoreSelection: function(sel)
	{
		var offset = 0, range = document.createRange(), found = false, stop = {};
		range.collapse(this.element, 0);

		var processText = function(n)
		{
			var nextOffset = offset + n.length;

			if (!found && sel.start >= offset && sel.start <= nextOffset)
			{
				range.setStart(n, sel.start - offset);
				found = true;
			}

			if (found && sel.end >= offset && sel.end <= nextOffset)
			{
				range.setEnd(n, sel.end - offset);
				throw stop;
			}

			offset = nextOffset;
		}

		try
		{
			this.traverseText(this.element, processText);
		}
		catch (ex)
		{
			if (ex != stop)
				throw ex;

			window.getSelection().removeAllRanges();
			window.getSelection().addRange(range);
		}
	},
});

window.addEvent('domready', function(){ new phpEditor($('c')); });
</script>
</head><body>
<code class="sh_php" contentEditable="true" id="c">&lt;?php

class Stuff
{
	/*
		Important comment
	*/
	public static function countObjTypes( array $data, array $types )
	{
#		$return['Other'] = 0;

		foreach ( ( array ) $data as $obj ) {
			$set = false;
			array_walk( $types, function( $type ) use ( $obj, &amp;$return, &amp;$set )
			{
				if ( is_a( $obj, $type ) ) {
					$return[$type]++;
					$set = true;
				}
			} );
		}

		return $return;
	}
}

// An example of how to use it
$form  = new Form( 'Form', 'post' );

$honeyPot1 = new HoneyPotField( time() );
$honeyPot1-&gt;validator( new Validator( new HoneyPotTimeRule( 'This form was filled in too quickly, assumed bot, please allow 2 seconds to fill in the form' ) ) );
$honeyPot2 = new HoneyPotField();
$honeyPot2-&gt;validator( new Validator( new EqualRule( 'This field was unexpectedly filled in, assumed bot', '' ) ) );

if( $form-&gt;isSubmitted() )
	$form-&gt;validate(  );
echo $form-&gt;render(  ); // outputs the form + elements</code>
</body></html>
