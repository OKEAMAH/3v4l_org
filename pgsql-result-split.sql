ALTER TABLE result
	DROP CONSTRAINT result_version_fkey,
	DROP CONSTRAINT "inputVersionRun";
ALTER TABLE input DROP "quickVersion";

/* select 'WHEN '||old_id||' THEN '||id from version where old_id!=id order by old_id asc */
UPDATE result SET version = (CASE version
	WHEN   5 THEN 3
	WHEN  14 THEN 1
	WHEN 147 THEN 2
	WHEN 199 THEN 4

	WHEN  54 THEN 41
	WHEN  55 THEN 42
	WHEN  41 THEN 43
	WHEN  56 THEN 44
	WHEN  42 THEN 45
	WHEN  57 THEN 46
	WHEN  43 THEN 47
	WHEN  58 THEN 48
	WHEN  44 THEN 49
	WHEN  59 THEN 50
	WHEN  45 THEN 51
	WHEN  60 THEN 52
	WHEN  61 THEN 53
	WHEN  46 THEN 54
	WHEN  62 THEN 55
	WHEN  63 THEN 56
	WHEN  64 THEN 57
	WHEN  47 THEN 58
	WHEN  65 THEN 59
	WHEN  48 THEN 60
	WHEN  66 THEN 61
	WHEN  67 THEN 62
	WHEN  68 THEN 63
	WHEN  49 THEN 64
	WHEN  50 THEN 65
	WHEN  51 THEN 66
	WHEN  69 THEN 67
	WHEN  70 THEN 68
	WHEN  71 THEN 69
	WHEN  72 THEN 70
	WHEN  52 THEN 71
	WHEN  73 THEN 72
	WHEN  53 THEN 73
	WHEN  85 THEN 78
	WHEN  78 THEN 79
	WHEN  86 THEN 80
	WHEN  79 THEN 81
	WHEN  80 THEN 82
	WHEN  87 THEN 83
	WHEN  81 THEN 84
	WHEN  88 THEN 85
	WHEN  82 THEN 86
	WHEN  89 THEN 87
	WHEN  83 THEN 88
	WHEN  84 THEN 89
	WHEN 104 THEN 96
	WHEN 105 THEN 97
	WHEN  96 THEN 98
	WHEN 106 THEN 99
	WHEN  97 THEN 100
	WHEN  98 THEN 101
	WHEN 107 THEN 102
	WHEN 108 THEN 103
	WHEN  99 THEN 104
	WHEN 109 THEN 105
	WHEN 100 THEN 106
	WHEN 101 THEN 107
	WHEN 110 THEN 108
	WHEN 111 THEN 109
	WHEN 146 THEN 110
	WHEN 112 THEN 111
	WHEN 102 THEN 112
	WHEN 103 THEN 113
	WHEN 113 THEN 114
	WHEN 114 THEN 115
	WHEN 115 THEN 116
	WHEN 116 THEN 118
	WHEN 118 THEN 119
	WHEN 119 THEN 120
	WHEN 122 THEN 121
	WHEN 125 THEN 122
	WHEN 121 THEN 123
	WHEN 120 THEN 124
	WHEN 124 THEN 125
	WHEN 123 THEN 126
	WHEN 128 THEN 127
	WHEN 127 THEN 128
	WHEN 126 THEN 129
	WHEN 129 THEN 130
	WHEN 130 THEN 131
	WHEN 135 THEN 132
	WHEN 131 THEN 133
	WHEN 132 THEN 135
	WHEN 133 THEN 136
	WHEN 136 THEN 138
	WHEN 141 THEN 139
	WHEN 138 THEN 140
	WHEN 140 THEN 141
	WHEN 139 THEN 142
	WHEN 142 THEN 144
	WHEN 144 THEN 145

	WHEN  15 THEN 146
	WHEN  16 THEN 147
	WHEN  18 THEN 148
	WHEN  19 THEN 149
	WHEN  21 THEN 150
	WHEN  22 THEN 151
	WHEN  25 THEN 152
	WHEN  24 THEN 153
	WHEN  26 THEN 154

	WHEN 145 THEN 155

	WHEN  13 THEN 156

	WHEN 148 THEN 157
	WHEN 149 THEN 158

	WHEN   6 THEN 159
	WHEN   9 THEN 160
	WHEN  11 THEN 161

	WHEN 152 THEN 162
	WHEN 153 THEN 163
	WHEN 154 THEN 164
	WHEN 155 THEN 165
	WHEN 159 THEN 166
	WHEN 160 THEN 167
	WHEN 162 THEN 168
	WHEN 161 THEN 169
	WHEN 167 THEN 170
	WHEN 165 THEN 171
	WHEN 166 THEN 172
	WHEN 171 THEN 173
	WHEN 173 THEN 174
	WHEN 172 THEN 175
	WHEN 174 THEN 177
	WHEN 175 THEN 178
	WHEN 182 THEN 179
	WHEN 184 THEN 180
	WHEN 183 THEN 181
	WHEN 189 THEN 182
	WHEN 190 THEN 183
	WHEN 188 THEN 184
	WHEN 196 THEN 185
	WHEN 193 THEN 186
	WHEN 194 THEN 187
	WHEN 195 THEN 188
	WHEN 201 THEN 189
	WHEN 200 THEN 190
	WHEN 202 THEN 191
	WHEN 204 THEN 192
	WHEN 205 THEN 193
	WHEN 206 THEN 194
	WHEN 207 THEN 195
	WHEN 208 THEN 196
	WHEN 209 THEN 197
	WHEN 211 THEN 198
	WHEN 213 THEN 199
	WHEN 210 THEN 200
	WHEN 214 THEN 201
	WHEN 219 THEN 202
	WHEN 215 THEN 203
	WHEN 216 THEN 204
	WHEN 217 THEN 205
	WHEN 218 THEN 206
	WHEN 220 THEN 207
	WHEN 221 THEN 208
	WHEN 222 THEN 209
	WHEN 223 THEN 210
	WHEN 224 THEN 211
	WHEN 225 THEN 212
	WHEN 226 THEN 213
	WHEN 227 THEN 214
	WHEN 228 THEN 215
	ELSE version
END);

ALTER TABLE result RENAME TO result_org;

/* do this now or result_org fkeys get altered when we do this */
ALTER TABLE version RENAME TO version_org;
CREATE TABLE version (LIKE version_org INCLUDING ALL);

GRANT SELECT ON TABLE version TO website;
GRANT SELECT ON TABLE version TO daemon;
ALTER SEQUENCE version_id_seq OWNED BY version.id;

CREATE TABLE result (LIKE result_org);

GRANT SELECT ON TABLE result TO website;
GRANT INSERT ON TABLE result TO daemon;

CREATE TABLE result_archive (CONSTRAINT "isArchive" CHECK (version >= 32 AND version <= 108)) INHERITS (result);
CREATE TABLE result_current (CONSTRAINT "isCurrent" CHECK (version < 32 OR version > 108)) INHERITS (result);

GRANT INSERT ON TABLE result_archive TO daemon;
GRANT INSERT ON TABLE result_current TO daemon;
GRANT SELECT ON TABLE result_current TO website;

ALTER TABLE result_archive
	ADD CONSTRAINT "inputVersionRunArchive" UNIQUE (input, version, run),
	ADD CONSTRAINT result_archive_input_fkey FOREIGN KEY (input) REFERENCES input(id) ON UPDATE RESTRICT ON DELETE CASCADE,
	ADD CONSTRAINT result_archive_output_fkey FOREIGN KEY (output) REFERENCES output(id) ON UPDATE RESTRICT ON DELETE CASCADE,
	ADD CONSTRAINT result_archive_version_fkey FOREIGN KEY (version) REFERENCES version(id) ON UPDATE RESTRICT ON DELETE CASCADE;
ALTER TABLE result_archive CLUSTER ON "inputVersionRunArchive";

ALTER TABLE result_current
	ADD CONSTRAINT "inputVersionRun" UNIQUE (input, version, run),
	ADD CONSTRAINT result_current_input_fkey FOREIGN KEY (input) REFERENCES input(id) ON UPDATE RESTRICT ON DELETE CASCADE,
	ADD CONSTRAINT result_current_output_fkey FOREIGN KEY (output) REFERENCES output(id) ON UPDATE RESTRICT ON DELETE CASCADE,
	ADD CONSTRAINT result_current_version_fkey FOREIGN KEY (version) REFERENCES version(id) ON UPDATE RESTRICT ON DELETE CASCADE;
ALTER TABLE result_current CLUSTER ON "inputVersionRun";

CREATE FUNCTION result_insert_trigger()
RETURNS TRIGGER AS $$
BEGIN
	IF ( NEW.version < 32 OR NEW.version > 108 ) THEN
		INSERT INTO result_current VALUES (NEW.*);
	ELSE
		INSERT INTO result_archive VALUES (NEW.*);
	END IF;
	RETURN NULL;
END;
$$
LANGUAGE plpgsql;

CREATE TRIGGER insert_result_trigger
	BEFORE INSERT ON result
	FOR EACH ROW EXECUTE PROCEDURE result_insert_trigger();

ALTER TABLE version ADD old_id smallint;

CREATE INDEX r ON version_org USING btree(released);
ALTER TABLE version_org CLUSTER on r;
CLUSTER version_org;

CREATE TEMPORARY SEQUENCE tmpver START 1;
INSERT INTO version SELECT name,released,"order",command,"isHelper",nextval('tmpver'),id FROM version_org WHERE "isHelper" ORDER BY released ASC NULLS FIRST;
ALTER SEQUENCE tmpver RESTART WITH 32;

INSERT INTO version SELECT name,released,"order",command,"isHelper",nextval('tmpver'),id FROM version_org WHERE NOT "isHelper" ORDER BY released ASC;
ALTER SEQUENCE version_id_seq RESTART WITH 215;

INSERT INTO result_current SELECT * FROM result_org WHERE version < 32  OR version > 108;
INSERT INTO result_archive SELECT * FROM result_org WHERE version > 32 AND version < 109;

/* introduce input.runArchived */
ALTER TABLE input ADD "runArchived" boolean DEFAULT false;
UPDATE input SET "runArchived" = true;
GRANT UPDATE("runArchived") ON TABLE input TO website;

ALTER TABLE queue ADD "untilVersion" boolean DEFAULT false NOT NULL;